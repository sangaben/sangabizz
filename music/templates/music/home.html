{% extends "base.html" %}
{% load static %}

{% block title %}Home - Sangabiz{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="container">
        <h1>Discover Your Sound</h1>
        <p>Stream millions of songs, create playlists, and share your favorite tracks with the world.</p>
        <div class="cta-buttons">
            {% if user.is_authenticated %}
            <button class="primary-btn" onclick="startListening()">Start Listening</button>
            {% else %}
            <button class="primary-btn" onclick="showSignupModal()">Get Started Free</button>
            <button class="secondary-btn" onclick="showLoginModal()">Login</button>
            {% endif %}
        </div>
    </div>
</section>

<!-- Featured Songs -->
<section class="container">
    <h2 class="section-title">
        <i class="fas fa-fire"></i>
        Featured Songs
    </h2>
    <div class="featured-grid">
        {% for song in featured_songs %}
        <div class="song-card">
            <div class="card-image" style="background-image: url('{% if song.cover_image %}{{ song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}')"></div>
            <div class="card-content">
                <h3>{{ song.title }}</h3>
                <p>{{ song.artist.name }} â€¢ {{ song.genre.name }}</p>
                <div class="card-actions">
                    <button class="play-btn" onclick="playSongFromCard({{ song.id }})">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="action-btn" onclick="likeSong({{ song.id }}, this)">
                        <i class="far fa-heart"></i>
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <p>No featured songs available.</p>
        {% endfor %}
    </div>
</section>

<!-- Genres Section -->
<section class="container genres-section">
    <h2 class="section-title">
        <i class="fas fa-compass"></i>
        Browse Genres
    </h2>
    <div class="genres-grid">
        {% for genre in genres %}
        <a href="{% url 'genre_songs' genre.id %}" style="text-decoration: none;">
            <div class="genre-card" style="background: {{ genre.color|default:'linear-gradient(135deg, #6c5ce7, #fd79a8)' }};">
                <span>{{ genre.name }}</span>
            </div>
        </a>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Initialize playlist with featured songs
const featuredSongs = [
    {% for song in featured_songs %}
    {
        id: {{ song.id }},
        title: "{{ song.title }}",
        artist: "{{ song.artist.name }}",
        cover: "{% if song.cover_image %}{{ song.cover_image.url }}{% else %}{% static 'images/default-cover.jpg' %}{% endif %}",
        audio: "{{ song.audio_file.url }}",
        duration: {{ song.duration }}
    },
    {% endfor %}
];

initializePlaylist(featuredSongs);

function startListening() {
    if (featuredSongs.length > 0) {
        playSong(featuredSongs[0]);
    }
}

function playSongFromCard(songId) {
    const song = featuredSongs.find(s => s.id === songId);
    if (song) {
        playSong(song);
    }
}

function likeSong(songId, button) {
    {% if user.is_authenticated %}
    fetch(`/like-song/${songId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const icon = button.querySelector('i');
        if (data.liked) {
            icon.classList.remove('far');
            icon.classList.add('fas');
            button.style.color = 'var(--secondary)';
        } else {
            icon.classList.remove('fas');
            icon.classList.add('far');
            button.style.color = 'var(--gray)';
        }
    })
    .catch(error => {
        console.error('Error liking song:', error);
    });
    {% else %}
    showModal(loginModal);
    {% endif %}
}

function showSignupModal() {
    showModal(signupModal);
}

function showLoginModal() {
    showModal(loginModal);
}
</script>
{% endblock %}